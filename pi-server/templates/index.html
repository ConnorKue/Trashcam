<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRASHCAM TERMINAL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', 'Lucida Console', monospace;
            background: #0a0a0a;
            color: #33ff33;
            min-height: 100vh;
            padding: 20px;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(51, 255, 51, 0.03) 2px, rgba(51, 255, 51, 0.03) 4px);
            cursor: none;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #000000;
            border: 3px solid #33ff33;
            padding: 25px;
            box-shadow: 
                0 0 20px rgba(51, 255, 51, 0.4),
                inset 0 0 30px rgba(0, 0, 0, 0.8);
        }
        
        h1 {
            color: #33ff33;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(51, 255, 51, 0.8);
            letter-spacing: 8px;
            font-weight: normal;
            border-bottom: 2px solid #33ff33;
            padding-bottom: 12px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 20, 0, 0.6);
            padding: 18px;
            border: 2px solid #33ff33;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.9);
        }
        
        .status-info {
            display: flex;
            gap: 35px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
        }
        
        .status-label {
            font-size: 10px;
            color: #22aa22;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 6px;
        }
        
        .status-value {
            font-size: 22px;
            font-weight: bold;
            color: #33ff33;
            text-shadow: 0 0 8px rgba(51, 255, 51, 0.6);
        }
        
        .fill-percentage {
            color: #ffaa00;
            text-shadow: 0 0 8px rgba(255, 170, 0, 0.8);
        }
        
        .calibrate-btn {
            background: #000;
            color: #33ff33;
            border: 2px solid #33ff33;
            padding: 12px 24px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.3);
        }
        
        .calibrate-btn:hover {
            background: #33ff33;
            color: #000;
            box-shadow: 0 0 20px rgba(51, 255, 51, 0.8);
        }
        
        .calibrate-btn:active {
            transform: scale(0.98);
        }
        
        .calibrate-btn:disabled {
            background: #000;
            color: #114411;
            border-color: #114411;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .streams-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stream-box {
            background: rgba(0, 20, 0, 0.4);
            border: 2px solid #33ff33;
            padding: 15px;
            box-shadow: 
                0 0 15px rgba(51, 255, 51, 0.2),
                inset 0 0 15px rgba(0, 0, 0, 0.9);
        }
        
        .stream-title {
            font-size: 14px;
            font-weight: bold;
            color: #33ff33;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 6px rgba(51, 255, 51, 0.6);
        }
        
        .stream-box img {
            width: 100%;
            border: 1px solid #22aa22;
            background: #000;
        }
        
        .message {
            padding: 12px 15px;
            border: 2px solid;
            margin-bottom: 20px;
            display: none;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .message.success {
            background: rgba(0, 50, 0, 0.8);
            color: #33ff33;
            border-color: #33ff33;
        }
        
        .message.error {
            background: rgba(50, 0, 0, 0.8);
            color: #ff3333;
            border-color: #ff3333;
        }
        
        .message.info {
            background: rgba(50, 50, 0, 0.8);
            color: #ffaa00;
            border-color: #ffaa00;
        }
        
        .progress-bar {
            width: 100%;
            height: 38px;
            background: #000;
            border: 2px solid #33ff33;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.9);
        }
        
        .progress-fill {
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                #33ff33 0px,
                #33ff33 10px,
                #22cc22 10px,
                #22cc22 20px
            );
            transition: width 420ms cubic-bezier(.2,.8,.2,1);
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.6);
            will-change: width;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 16px;
            z-index: 10;
            letter-spacing: 2px;
            pointer-events: none;
            /* Always use black text with strong white glow for maximum contrast */
            color: #000000;
            text-shadow: 
                0 0 8px rgba(255, 255, 255, 1),
                0 0 12px rgba(255, 255, 255, 0.8),
                1px 1px 0 rgba(255, 255, 255, 0.9),
                -1px -1px 0 rgba(255, 255, 255, 0.9),
                1px -1px 0 rgba(255, 255, 255, 0.9),
                -1px 1px 0 rgba(255, 255, 255, 0.9);
        }
        
        .controls-panel {
            background: rgba(0, 20, 0, 0.4);
            border: 2px solid #33ff33;
            padding: 18px;
            margin-top: 20px;
            box-shadow: 
                0 0 15px rgba(51, 255, 51, 0.2),
                inset 0 0 15px rgba(0, 0, 0, 0.9);
        }
        
        .controls-title {
            font-size: 14px;
            font-weight: bold;
            color: #33ff33;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 6px rgba(51, 255, 51, 0.6);
        }
        
        .toggle-btn {
            background: #000;
            color: #33ff33;
            border: 1px solid #33ff33;
            padding: 5px 14px;
            font-size: 11px;
            cursor: pointer;
            margin-left: auto;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        
        .toggle-btn:hover {
            background: #33ff33;
            color: #000;
        }
        
        .controls-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-label {
            font-size: 11px;
            font-weight: 600;
            color: #22aa22;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .control-value {
            font-size: 11px;
            color: #ffaa00;
            font-weight: bold;
        }
        
        .control-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #33ff33;
            background: #000;
            color: #33ff33;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s;
        }
        
        .control-input:focus {
            outline: none;
            border-color: #55ff55;
            box-shadow: 0 0 8px rgba(51, 255, 51, 0.5);
        }
        
        input[type="range"] {
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #000;
            border: 1px solid #33ff33;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #33ff33;
            border: 2px solid #33ff33;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(51, 255, 51, 0.6);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #33ff33;
            border: 2px solid #33ff33;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(51, 255, 51, 0.6);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #55ff55;
            box-shadow: 0 0 12px rgba(51, 255, 51, 0.9);
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            background: #55ff55;
            box-shadow: 0 0 12px rgba(51, 255, 51, 0.9);
        }
        
        select.control-input {
            cursor: pointer;
        }
        
        select.control-input option {
            background: #000;
            color: #33ff33;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TRASHCAM TERMINAL</h1>
        
        <div id="message" class="message"></div>
        
        <div class="status-bar">
            <div class="status-info">
                <div class="status-item">
                    <span class="status-label">Fill Level</span>
                    <span class="status-value fill-percentage" id="fillPercentage">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Empty Baseline</span>
                    <span class="status-value" id="emptyDepth">-- mm</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Current Depth</span>
                    <span class="status-value" id="currentDepth">-- mm</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Calibration Date</span>
                    <span class="status-value" id="calibrationDate" style="font-size: 14px;">--</span>
                </div>
            </div>
            <button class="calibrate-btn" id="calibrateBtn" onclick="calibrate()">
                Calibrate Empty
            </button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            <div class="progress-text" id="progressText">0%</div>
        </div>
        
        <div class="controls-panel">
            <div class="controls-title">
                BOUNDING BOX CONTROLS
                <button class="toggle-btn" id="toggleBtn" onclick="toggleControls()">Hide</button>
            </div>
            <div class="controls-content" id="controlsContent">
                <div class="control-group">
                    <label class="control-label">
                        Shape
                    </label>
                    <select class="control-input" id="shape" onchange="updateBoundingBox()">
                        <option value="rectangle">Rectangle</option>
                        <option value="circle">Circle</option>
                        <option value="polygon">Polygon</option>
                    </select>
                </div>
                
                <div class="control-group" id="numSidesGroup" style="display: none;">
                    <label class="control-label">
                        Polygon Sides
                        <span class="control-value" id="numSidesValue">6</span>
                    </label>
                    <input type="range" class="control-input" id="numSides" min="3" max="12" value="6" step="1" oninput="updateBoundingBox()">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Center X
                        <span class="control-value" id="centerXValue">50%</span>
                    </label>
                    <input type="range" class="control-input" id="centerX" min="0" max="100" value="50" step="1" oninput="updateBoundingBox()">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Center Y
                        <span class="control-value" id="centerYValue">50%</span>
                    </label>
                    <input type="range" class="control-input" id="centerY" min="0" max="100" value="50" step="1" oninput="updateBoundingBox()">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Width
                        <span class="control-value" id="widthValue">60%</span>
                    </label>
                    <input type="range" class="control-input" id="width" min="10" max="100" value="60" step="1" oninput="updateBoundingBox()">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Height
                        <span class="control-value" id="heightValue">60%</span>
                    </label>
                    <input type="range" class="control-input" id="height" min="10" max="100" value="60" step="1" oninput="updateBoundingBox()">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Rotation
                        <span class="control-value" id="rotationValue">0°</span>
                    </label>
                    <input type="range" class="control-input" id="rotation" min="0" max="360" value="0" step="1" oninput="updateBoundingBox()">
                </div>
            </div>
        </div>
        
        <div class="streams-container">
            <div class="stream-box">
                <div class="stream-title">COLOR STREAM</div>
                <img src="http://{{ server_ip }}:8080/color" alt="Color Stream" id="colorStream">
            </div>
            <div class="stream-box">
                <div class="stream-title">DEPTH ANALYSIS</div>
                <img src="http://{{ server_ip }}:8080/depth_cropped" alt="Depth Stream" id="depthStream">
            </div>
        </div>
    </div>
    
    <script>
        const SERVER_IP = "{{ server_ip }}";
        let updateTimer = null;
        
        function showMessage(text, type) {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.className = `message ${type}`;
            msgEl.style.display = 'block';
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 5000);
        }
        
        function toggleControls() {
            const content = document.getElementById('controlsContent');
            const btn = document.getElementById('toggleBtn');
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        async function updateBoundingBox() {
            // Update value displays
            const shape = document.getElementById('shape').value;
            const centerX = document.getElementById('centerX').value;
            const centerY = document.getElementById('centerY').value;
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const rotation = document.getElementById('rotation').value;
            const numSides = document.getElementById('numSides').value;
            
            document.getElementById('centerXValue').textContent = centerX + '%';
            document.getElementById('centerYValue').textContent = centerY + '%';
            document.getElementById('widthValue').textContent = width + '%';
            document.getElementById('heightValue').textContent = height + '%';
            document.getElementById('rotationValue').textContent = rotation + '°';
            document.getElementById('numSidesValue').textContent = numSides;
            
            // Show/hide polygon sides control
            const numSidesGroup = document.getElementById('numSidesGroup');
            if (shape === 'polygon') {
                numSidesGroup.style.display = 'flex';
            } else {
                numSidesGroup.style.display = 'none';
            }
            
            // Debounce the API call
            if (updateTimer) {
                clearTimeout(updateTimer);
            }
            
            updateTimer = setTimeout(async () => {
                try {
                    const response = await fetch('/api/bounding_box', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            shape: shape,
                            center_x: parseFloat(centerX) / 100,
                            center_y: parseFloat(centerY) / 100,
                            width: parseFloat(width) / 100,
                            height: parseFloat(height) / 100,
                            rotation: parseFloat(rotation),
                            num_sides: parseInt(numSides)
                        })
                    });
                    
                    const data = await response.json();
                    if (!data.success) {
                        console.error('Failed to update bounding box:', data.error);
                    }
                } catch (error) {
                    console.error('Error updating bounding box:', error);
                }
            }, 100); // 100ms debounce
        }
        
        async function loadBoundingBoxSettings() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.success && data.bounding_box) {
                    const bb = data.bounding_box;
                    document.getElementById('shape').value = bb.shape || 'rectangle';
                    document.getElementById('centerX').value = Math.round((bb.center_x || 0.5) * 100);
                    document.getElementById('centerY').value = Math.round((bb.center_y || 0.5) * 100);
                    document.getElementById('width').value = Math.round((bb.width || 0.6) * 100);
                    document.getElementById('height').value = Math.round((bb.height || 0.6) * 100);
                    document.getElementById('rotation').value = bb.rotation || 0;
                    document.getElementById('numSides').value = bb.num_sides || 6;
                    
                    // Update displays without triggering API call
                    document.getElementById('centerXValue').textContent = document.getElementById('centerX').value + '%';
                    document.getElementById('centerYValue').textContent = document.getElementById('centerY').value + '%';
                    document.getElementById('widthValue').textContent = document.getElementById('width').value + '%';
                    document.getElementById('heightValue').textContent = document.getElementById('height').value + '%';
                    document.getElementById('rotationValue').textContent = document.getElementById('rotation').value + '°';
                    document.getElementById('numSidesValue').textContent = document.getElementById('numSides').value;
                    
                    // Show/hide polygon sides
                    const numSidesGroup = document.getElementById('numSidesGroup');
                    if (bb.shape === 'polygon') {
                        numSidesGroup.style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('Failed to load bounding box settings:', error);
            }
        }
        
        async function calibrate() {
            const btn = document.getElementById('calibrateBtn');
            btn.disabled = true;
            btn.textContent = 'Calibrating...';
            
            showMessage('Starting calibration... Please ensure trash can is EMPTY!', 'info');
            
            try {
                const response = await fetch('/api/calibrate', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Calibration successful! Empty depth: ${data.empty_depth.toFixed(1)}mm`, 'success');
                    updateStatus();
                } else {
                    showMessage(`Calibration failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Calibrate Empty';
            }
        }
        
        let smoothedFill = null;
        async function updateStatus() {
            try {
                const response = await fetch('/api/status', { cache: 'no-store' });
                const data = await response.json();

                if (data.success) {
                    const rawValue = (data.fill_percentage !== null && !isNaN(data.fill_percentage)) ? Math.max(0, Math.min(100, data.fill_percentage)) : 0;

                    if (smoothedFill === null) smoothedFill = rawValue;
                    // simple low-pass smoothing to reduce jitter
                    smoothedFill = smoothedFill * 0.7 + rawValue * 0.3;

                    const displayPct = (Math.round(smoothedFill * 10) / 10).toFixed(1) + '%';
                    document.getElementById('fillPercentage').textContent = displayPct;

                    document.getElementById('emptyDepth').textContent = data.empty_depth !== null ? data.empty_depth.toFixed(1) + ' mm' : '--';
                    document.getElementById('currentDepth').textContent = data.current_depth !== null ? data.current_depth.toFixed(1) + ' mm' : '--';
                    if (data.calibration_date) document.getElementById('calibrationDate').textContent = data.calibration_date;

                    // Update progress bar (use smoothed value)
                    const progressFill = document.getElementById('progressFill');
                    const progressText = document.getElementById('progressText');
                    progressFill.style.width = smoothedFill.toFixed(1) + '%';
                    progressText.textContent = displayPct;
                }
            } catch (error) {
                console.error('Failed to update status:', error);
            }
        }
        
        // Load bounding box settings on page load
        loadBoundingBoxSettings();
        
        // Update status every 2 seconds
        updateStatus();
        setInterval(updateStatus, 2000);
        
        // Refresh streams periodically to prevent stale images
        setInterval(() => {
            const colorStream = document.getElementById('colorStream');
            const depthStream = document.getElementById('depthStream');
            colorStream.src = colorStream.src.split('?')[0] + '?' + new Date().getTime();
            depthStream.src = depthStream.src.split('?')[0] + '?' + new Date().getTime();
        }, 30000);
    </script>
</body>
</html>
